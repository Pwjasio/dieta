<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Date & Time Manager - SQL Server</title>
    <link rel="stylesheet" href="dieta.css">    
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìÖ Date & Time Manager</h1>
            <p>Manage your important dates with SQL Server integration</p>
            <div class="status-indicator" id="connectionStatus">
                üîå Checking connection...
            </div>
            <div class="database-controls">
                <button class="db-btn save-btn" onclick="saveToDatabase()">üíæ Save All</button>
                <button class="db-btn load-btn" onclick="loadFromDatabase()">üìÇ Load All</button>
                <button class="db-btn export-btn" onclick="exportData()">üì§ Export</button>
                <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
                <button class="db-btn import-btn" onclick="document.getElementById('importFile').click()">üì• Import</button>
                <button class="db-btn clear-btn" onclick="clearDatabase()">üóëÔ∏è Clear DB</button>
            </div>
        </div>

        <div class="dates-grid">
            <div class="date-card">
                <h3>Date 1</h3>
                <div class="input-group">
                    <label for="label1">Label:</label>
                    <input type="text" id="label1" placeholder="Enter description..." onchange="autoSave()">
                </div>
                <div class="input-group">
                    <label for="date1">Current Timestamp (UTC+1):</label>
                    <input type="datetime-local" id="date1" step="1">
                </div>
                <div class="input-group">
                    <label for="time1">Add Time (hours):</label>
                    <input type="number" id="time1" value="0" min="0" step="0.5">
                </div>
                <div class="time-controls">
                    <button class="time-btn add-btn" onclick="addTime(1, 1)">+1 Hour</button>
                    <button class="time-btn add-btn" onclick="addTime(1, 0.5)">+30 Min</button>
                    <button class="time-btn add-btn" onclick="addTime(1, 24)">+1 Day</button>
                </div>
                <div class="time-controls">
                    <button class="time-btn subtract-btn" onclick="addTime(1, -1)">-1 Hour</button>
                    <button class="time-btn subtract-btn" onclick="addTime(1, -0.5)">-30 Min</button>
                    <button class="time-btn subtract-btn" onclick="addTime(1, -24)">-1 Day</button>
                </div>
                <div class="current-display">
                    <strong>Result:</strong> <span id="result1">Select a timestamp first</span>
                </div>
                <button class="reset-btn" onclick="resetDate(1)">Reset</button>
            </div>

            <div class="date-card">
                <h3>Date 2</h3>
                <div class="input-group">
                    <label for="label2">Label:</label>
                    <input type="text" id="label2" placeholder="Enter description..." onchange="autoSave()">
                </div>
                <div class="input-group">
                    <label for="date2">Current Timestamp (UTC+1):</label>
                    <input type="datetime-local" id="date2" step="1">
                </div>
                <div class="input-group">
                    <label for="time2">Add Time (hours):</label>
                    <input type="number" id="time2" value="0" min="0" step="0.5">
                </div>
                <div class="time-controls">
                    <button class="time-btn add-btn" onclick="addTime(2, 1)">+1 Hour</button>
                    <button class="time-btn add-btn" onclick="addTime(2, 0.5)">+30 Min</button>
                    <button class="time-btn add-btn" onclick="addTime(2, 24)">+1 Day</button>
                </div>
                <div class="time-controls">
                    <button class="time-btn subtract-btn" onclick="addTime(2, -1)">-1 Hour</button>
                    <button class="time-btn subtract-btn" onclick="addTime(2, -0.5)">-30 Min</button>
                    <button class="time-btn subtract-btn" onclick="addTime(2, -24)">-1 Day</button>
                </div>
                <div class="current-display">
                    <strong>Result:</strong> <span id="result2">Select a timestamp first</span>
                </div>
                <button class="reset-btn" onclick="resetDate(2)">Reset</button>
            </div>

            <div class="date-card">
                <h3>Date 3</h3>
                <div class="input-group">
                    <label for="label3">Label:</label>
                    <input type="text" id="label3" placeholder="Enter description..." onchange="autoSave()">
                </div>
                <div class="input-group">
                    <label for="date3">Current Timestamp (UTC+1):</label>
                    <input type="datetime-local" id="date3" step="1">
                </div>
                <div class="input-group">
                    <label for="time3">Add Time (hours):</label>
                    <input type="number" id="time3" value="0" min="0" step="0.5">
                </div>
                <div class="time-controls">
                    <button class="time-btn add-btn" onclick="addTime(3, 1)">+1 Hour</button>
                    <button class="time-btn add-btn" onclick="addTime(3, 0.5)">+30 Min</button>
                    <button class="time-btn add-btn" onclick="addTime(3, 24)">+1 Day</button>
                </div>
                <div class="time-controls">
                    <button class="time-btn subtract-btn" onclick="addTime(3, -1)">-1 Hour</button>
                    <button class="time-btn subtract-btn" onclick="addTime(3, -0.5)">-30 Min</button>
                    <button class="time-btn subtract-btn" onclick="addTime(3, -24)">-1 Day</button>
                </div>
                <div class="current-display">
                    <strong>Result:</strong> <span id="result3">Select a timestamp first</span>
                </div>
                <button class="reset-btn" onclick="resetDate(3)">Reset</button>
            </div>

            <div class="date-card">
                <h3>Date 4</h3>
                <div class="input-group">
                    <label for="label4">Label:</label>
                    <input type="text" id="label4" placeholder="Enter description..." onchange="autoSave()">
                </div>
                <div class="input-group">
                    <label for="date4">Current Timestamp (UTC+1):</label>
                    <input type="datetime-local" id="date4" step="1">
                </div>
                <div class="input-group">
                    <label for="time4">Add Time (hours):</label>
                    <input type="number" id="time4" value="0" min="0" step="0.5">
                </div>
                <div class="time-controls">
                    <button class="time-btn add-btn" onclick="addTime(4, 1)">+1 Hour</button>
                    <button class="time-btn add-btn" onclick="addTime(4, 0.5)">+30 Min</button>
                    <button class="time-btn add-btn" onclick="addTime(4, 24)">+1 Day</button>
                </div>
                <div class="time-controls">
                    <button class="time-btn subtract-btn" onclick="addTime(4, -1)">-1 Hour</button>
                    <button class="time-btn subtract-btn" onclick="addTime(4, -0.5)">-30 Min</button>
                    <button class="time-btn subtract-btn" onclick="addTime(4, -24)">-1 Day</button>
                </div>
                <div class="current-display">
                    <strong>Result:</strong> <span id="result4">Select a timestamp first</span>
                </div>
                <button class="reset-btn" onclick="resetDate(4)">Reset</button>
            </div>
        </div>

        <div class="footer">
            <p>üí° Tip: Data is automatically saved to SQL Server on every change</p>
        </div>
    </div>

    <script>
        // API base URL
        const API_BASE = 'http://localhost:3000/api';
        
        // Connection status
        let isConnected = false;
        
        // Check database connection
        async function checkConnection() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                isConnected = data.success;
                updateConnectionStatus();
            } catch (error) {
                console.error('Connection check failed:', error);
                isConnected = false;
                updateConnectionStatus();
            }
        }
        
        // Update connection status indicator
        function updateConnectionStatus() {
            const statusElement = document.getElementById('connectionStatus');
            if (isConnected) {
                statusElement.textContent = 'üü¢ Connected to SQL Server';
                statusElement.className = 'status-indicator status-connected';
            } else {
                statusElement.textContent = 'üî¥ Disconnected from SQL Server';
                statusElement.className = 'status-indicator status-disconnected';
            }
        }
        
        // Auto-save functionality
        async function autoSave() {
            if (!isConnected) return;
            
            const entries = [];
            for (let i = 1; i <= 4; i++) {
                const entry = {
                    id: i,
                    label: document.getElementById(`label${i}`).value,
                    timestamp: document.getElementById(`date${i}`).value,
                    timeToAdd: document.getElementById(`time${i}`).value
                };
                entries.push(entry);
            }
            
            try {
                const response = await fetch(`${API_BASE}/entries/save`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ entries })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to save');
                }
            } catch (error) {
                console.error('Auto-save failed:', error);
            }
        }
        
        // Save current state to database
        async function saveToDatabase() {
            if (!isConnected) {
                showNotification('Not connected to SQL Server!', 'error');
                return;
            }
            
            const entries = [];
            for (let i = 1; i <= 4; i++) {
                const entry = {
                    id: i,
                    label: document.getElementById(`label${i}`).value,
                    timestamp: document.getElementById(`date${i}`).value,
                    timeToAdd: document.getElementById(`time${i}`).value
                };
                entries.push(entry);
            }
            
            try {
                const response = await fetch(`${API_BASE}/entries/save`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ entries })
                });
                
                const data = await response.json();
                if (data.success) {
                    showNotification('Data saved to SQL Server successfully!', 'success');
                } else {
                    showNotification(data.error || 'Failed to save data', 'error');
                }
            } catch (error) {
                console.error('Save failed:', error);
                showNotification('Failed to save data to SQL Server', 'error');
            }
        }
        
        // Load data from database
        async function loadFromDatabase() {
            if (!isConnected) {
                showNotification('Not connected to SQL Server!', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/entries`);
                const data = await response.json();
                
                if (data.success) {
                    if (data.data.length === 0) {
                        showNotification('No saved data found in SQL Server!', 'warning');
                        return;
                    }
                    
                    data.data.forEach(entry => {
                        if (entry.id >= 1 && entry.id <= 4) {
                            document.getElementById(`label${entry.id}`).value = entry.label || '';
                            document.getElementById(`date${entry.id}`).value = entry.timestamp ? 
                                new Date(entry.timestamp).toISOString().slice(0, 19) : '';
                            document.getElementById(`time${entry.id}`).value = entry.timeToAdd || '0';
                            updateResult(entry.id);
                        }
                    });
                    
                    showNotification('Data loaded from SQL Server successfully!', 'success');
                } else {
                    showNotification(data.error || 'Failed to load data', 'error');
                }
            } catch (error) {
                console.error('Load failed:', error);
                showNotification('Failed to load data from SQL Server', 'error');
            }
        }
        
        // Export data from SQL Server
        async function exportData() {
            if (!isConnected) {
                showNotification('Not connected to SQL Server!', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/export`);
                if (!response.ok) {
                    throw new Error('Export failed');
                }
                
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `timestamp_data_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showNotification('Data exported from SQL Server successfully!', 'success');
            } catch (error) {
                console.error('Export failed:', error);
                showNotification('Failed to export data from SQL Server', 'error');
            }
        }
        
        // Import data to SQL Server
        async function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!isConnected) {
                showNotification('Not connected to SQL Server!', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    let entries = [];
                    
                    // Handle different import formats
                    if (importedData.entries && Array.isArray(importedData.entries)) {
                        entries = importedData.entries;
                    } else if (Array.isArray(importedData)) {
                        entries = importedData;
                    } else {
                        showNotification('Invalid file format!', 'error');
                        return;
                    }
                    
                    const response = await fetch(`${API_BASE}/import`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ entries })
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        await loadFromDatabase();
                        showNotification('Data imported to SQL Server successfully!', 'success');
                    } else {
                        showNotification(data.error || 'Failed to import data', 'error');
                    }
                } catch (error) {
                    console.error('Import failed:', error);
                    showNotification('Error importing data to SQL Server', 'error');
                }
            };
            reader.readAsText(file);
            
            // Clear the file input
            event.target.value = '';
        }
        
        // Clear database
        async function clearDatabase() {
            if (!isConnected) {
                showNotification('Not connected to SQL Server!', 'error');
                return;
            }
            
            if (confirm('Are you sure you want to clear all data from SQL Server?')) {
                try {
                    const response = await fetch(`${API_BASE}/entries`, {
                        method: 'DELETE'
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        showNotification('SQL Server database cleared!', 'success');
                        // Reset all inputs
                        for (let i = 1; i <= 4; i++) {
                            document.getElementById(`label${i}`).value = '';
                            resetDate(i);
                        }
                    } else {
                        showNotification(data.error || 'Failed to clear database', 'error');
                    }
                } catch (error) {
                    console.error('Clear failed:', error);
                    showNotification('Failed to clear SQL Server database', 'error');
                }
            }
        }
        
        // Show notification
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            // Add styles
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 6px;
                color: white;
                font-weight: 500;
                z-index: 1000;
                opacity: 0;
                transform: translateX(100%);
                transition: all 0.3s ease;
                max-width: 300px;
                word-wrap: break-word;
            `;
            
            // Set background color based on type
            const colors = {
                success: '#28a745',
                warning: '#ffc107',
                error: '#dc3545'
            };
            notification.style.backgroundColor = colors[type] || colors.success;
            
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.style.opacity = '1';
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            // Remove after 4 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 4000);
        }
        
        // Set current timestamp in UTC+1 as default for all datetime inputs
        const now = new Date();
        const utcPlus1 = new Date(now.getTime() + (1 * 60 * 60 * 1000));
        const currentTimestamp = utcPlus1.toISOString().slice(0, 19);
        for (let i = 1; i <= 4; i++) {
            document.getElementById(`date${i}`).value = currentTimestamp;
        }

        // Add event listeners to update results when date or time changes
        for (let i = 1; i <= 4; i++) {
            document.getElementById(`date${i}`).addEventListener('change', () => {
                updateResult(i);
                if (isConnected) autoSave();
            });
            document.getElementById(`time${i}`).addEventListener('input', () => {
                updateResult(i);
                if (isConnected) autoSave();
            });
        }

        function updateResult(dateNum) {
            const dateInput = document.getElementById(`date${dateNum}`);
            const timeInput = document.getElementById(`time${dateNum}`);
            const resultSpan = document.getElementById(`result${dateNum}`);
            
            if (!dateInput.value) {
                resultSpan.textContent = 'Select a timestamp first';
                return;
            }
            
            const baseDate = new Date(dateInput.value);
            const hoursToAdd = parseFloat(timeInput.value) || 0;
            
            // Add the hours to the date
            const resultDate = new Date(baseDate.getTime() + (hoursToAdd * 60 * 60 * 1000));
            
            // Format the result with seconds
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                timeZone: 'Europe/Berlin' // UTC+1
            };
            
            resultSpan.textContent = resultDate.toLocaleDateString('en-US', options) + ' (UTC+1)';
        }

        function addTime(dateNum, hours) {
            const timeInput = document.getElementById(`time${dateNum}`);
            const currentTime = parseFloat(timeInput.value) || 0;
            const newTime = Math.max(0, currentTime + hours);
            timeInput.value = newTime;
            updateResult(dateNum);
            if (isConnected) autoSave();
        }

        function resetDate(dateNum) {
            const now = new Date();
            const utcPlus1 = new Date(now.getTime() + (1 * 60 * 60 * 1000));
            const currentTimestamp = utcPlus1.toISOString().slice(0, 19);
            document.getElementById(`date${dateNum}`).value = currentTimestamp;
            document.getElementById(`time${dateNum}`).value = 0;
            updateResult(dateNum);
            if (isConnected) autoSave();
        }

        // Initialize application
        async function initializeApp() {
            // Check connection first
            await checkConnection();
            
            // Initialize all results
            for (let i = 1; i <= 4; i++) {
                updateResult(i);
            }
            
            // Load saved data if connected
            if (isConnected) {
                await loadFromDatabase();
            }
            
            // Set up periodic connection check
            setInterval(checkConnection, 30000); // Check every 30 seconds
        }
        
        // Start the application
        initializeApp();
    </script>
</body>
</html>